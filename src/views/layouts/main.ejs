<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'App Empreiteiros' %></title>
    
    <!-- Scripts de inicialização e tratamento de erros -->
    <script src="/js/error-handler.js"></script>
    <script src="/js/app-init.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <% if (typeof pageHead !== 'undefined') { %>
        <%- pageHead %>
    <% } %>
</head>
<body>
    <!-- Navbar -->
    <% if ((typeof hideNav === 'undefined' || !hideNav) && (typeof hideNavbar === 'undefined' || !hideNavbar)) { %>
        <%- include('../partials/navbar') %>
    <% } %>

    <!-- Main Content -->
    <main class="container mt-4">
        <% if (typeof messages !== 'undefined' && messages.length > 0) { %>
            <div class="alert alert-info">
                <%= messages %>
            </div>
        <% } %>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
        <% } %>

        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success">
                <%= success %>
            </div>
        <% } %>

        <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
            <div class="alert alert-danger">
                <%= error_msg %>
            </div>
        <% } %>

        <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
            <div class="alert alert-success">
                <%= success_msg %>
            </div>
        <% } %>

        <!-- Conteúdo da página -->
        <div id="page-content">
            <%- body %>
        </div>
    </main>

    <!-- Footer -->
    <% if (typeof hideFooter === 'undefined' || !hideFooter) { %>
        <%- include('../partials/footer') %>
    <% } %>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/main.js"></script>
    
    <% if (typeof pageScripts !== 'undefined') { %>
        <%- pageScripts %>
    <% } %>
    
    <!-- Toast container para notificações -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <!-- Script para tratamento de erros no conteúdo da página -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Verificar se o conteúdo da página foi carregado corretamente
                const pageContent = document.getElementById('page-content');
                if (!pageContent || pageContent.innerHTML.trim() === '') {
                    throw new Error('Conteúdo da página não foi carregado corretamente');
                }
                
                // Verificar se há erros de sintaxe no conteúdo
                const scripts = pageContent.querySelectorAll('script');
                scripts.forEach(function(script) {
                    try {
                        // Tentar avaliar o script para verificar erros de sintaxe
                        if (script.textContent) {
                            new Function(script.textContent);
                        }
                    } catch (scriptError) {
                        console.error('Erro de sintaxe em script da página:', scriptError);
                        // Criar um limite de erro em torno do script
                        if (typeof errorHandler !== 'undefined' && errorHandler.createErrorBoundary) {
                            errorHandler.createErrorBoundary(script, 'Erro de sintaxe no script: ' + scriptError.message);
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar conteúdo da página:', error);
                // Mostrar mensagem de erro
                const mainContent = document.querySelector('main.container');
                if (mainContent) {
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger';
                    errorAlert.textContent = 'Erro ao carregar o conteúdo da página. Por favor, tente recarregar.';
                    
                    const reloadButton = document.createElement('button');
                    reloadButton.className = 'btn btn-danger mt-2';
                    reloadButton.textContent = 'Recarregar página';
                    reloadButton.addEventListener('click', function() {
                        window.location.reload();
                    });
                    
                    errorAlert.appendChild(document.createElement('br'));
                    errorAlert.appendChild(reloadButton);
                    
                    mainContent.prepend(errorAlert);
                }
            }
        });
    </script>
</body>
</html>